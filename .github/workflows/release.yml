name: Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for changelog

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'

      - name: Install opal and opal-vite gems
        run: |
          gem install opal
          cd gems/opal-vite && gem build opal-vite.gemspec && gem install *.gem

      - name: Install dependencies
        run: pnpm install

      - name: Build plugin
        run: pnpm build
        working-directory: packages/vite-plugin-opal

      - name: Run tests
        run: pnpm test
        working-directory: packages/vite-plugin-opal

      # Commented out: Manual publish preferred
      # - name: Publish to npm
      #   if: startsWith(github.ref, 'refs/tags/')
      #   run: pnpm publish --no-git-checks
      #   working-directory: packages/vite-plugin-opal
      #   env:
      #     NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Extract version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        run: |
          CHANGELOG=$(git log $(git describe --tags --abbrev=0 HEAD^)..HEAD --pretty=format:"- %s (%h)" --no-merges)
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.version.outputs.VERSION }}
          body: |
            ## Changes in this release

            ${{ steps.changelog.outputs.CHANGELOG }}

            ## Installation

            ```bash
            pnpm add -D vite-plugin-opal@${{ steps.version.outputs.VERSION }}
            ```

            ## Documentation

            See the [README](https://github.com/${{ github.repository }}/blob/master/README.md) for full documentation.

          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Commented out: Manual publish preferred
  # publish-gem:
  #   name: Publish Ruby Gem
  #   runs-on: ubuntu-latest
  #   if: startsWith(github.ref, 'refs/tags/')
  #
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Setup Ruby
  #       uses: ruby/setup-ruby@v1
  #       with:
  #         ruby-version: '3.2'
  #         bundler-cache: true
  #         working-directory: gems/opal-vite
  #
  #     - name: Build gem
  #       run: gem build opal-vite.gemspec
  #       working-directory: gems/opal-vite
  #
  #     - name: Publish to RubyGems
  #       run: |
  #         mkdir -p ~/.gem
  #         echo ":rubygems_api_key: ${RUBYGEMS_API_KEY}" > ~/.gem/credentials
  #         chmod 0600 ~/.gem/credentials
  #         gem push *.gem
  #       working-directory: gems/opal-vite
  #       env:
  #         RUBYGEMS_API_KEY: ${{ secrets.RUBYGEMS_API_KEY }}
