# PWA (Progressive Web App) Example

A comprehensive Progressive Web App example built with Opal, Stimulus, Vite, and vite-plugin-pwa, demonstrating offline functionality, installability, and service worker integration.

## Features

- **Service Worker**: Background script for offline functionality and caching
- **Installable**: Add to home screen for app-like experience
- **Offline Support**: Works without internet using cached resources
- **Online/Offline Detection**: Real-time network status monitoring
- **Local Storage**: Notes persist across sessions
- **Cache Management**: View and clear cached resources
- **Native Feel**: Theme color, splash screen, standalone display mode
- **Auto-Update**: Automatic service worker updates

## Getting Started

### Prerequisites

- Node.js 18+
- Ruby 3.0+
- pnpm (or npm/yarn)

### Installation

```bash
# Install dependencies
pnpm install
bundle install

# Start dev server
pnpm dev
```

The app will be available at `http://localhost:3013`

### Building for Production

```bash
pnpm build
```

The service worker and PWA manifest will be automatically generated during build.

## Project Structure

```
pwa-app/
├── app/
│   ├── javascript/
│   │   └── application.js                    # JavaScript entry point
│   ├── opal/
│   │   ├── application.rb                     # Opal entry point
│   │   └── controllers/
│   │       ├── pwa_controller.rb              # PWA functionality
│   │       └── offline_detector_controller.rb # Online/offline detection
│   └── styles.css                             # Application styles
├── public/
│   └── icons/                                 # PWA icons
├── index.html                                 # Main HTML
├── vite.config.ts                             # Vite + PWA config
├── package.json
└── Gemfile
```

## Key Components

### 1. Service Worker (Auto-generated by vite-plugin-pwa)

The service worker is automatically generated during build with:
- Precaching of all static assets
- Runtime caching for fonts and external resources
- Auto-update functionality

Configuration in `vite.config.ts`:

```typescript
VitePWA({
  registerType: 'autoUpdate',
  workbox: {
    globPatterns: ['**/*.{js,css,html,ico,png,svg,json}'],
    runtimeCaching: [
      {
        urlPattern: /^https:\/\/fonts\.googleapis\.com\/.*/i,
        handler: 'CacheFirst',
        options: {
          cacheName: 'google-fonts-cache',
          expiration: {
            maxEntries: 10,
            maxAgeSeconds: 60 * 60 * 24 * 365
          }
        }
      }
    ]
  }
})
```

### 2. Web App Manifest

The manifest is auto-generated with:

```json
{
  "name": "PWA Example - Opal + Stimulus",
  "short_name": "PWA Example",
  "description": "Progressive Web App example with offline support",
  "theme_color": "#667eea",
  "background_color": "#ffffff",
  "display": "standalone",
  "start_url": "/",
  "icons": [...]
}
```

### 3. PWA Controller

Handles PWA functionality:

```ruby
class PwaController < StimulusController
  # Checks service worker status
  def check_service_worker
    # ...
  end

  # Handles app installation
  def install
    # Uses beforeinstallprompt event
  end

  # Manages offline notes with localStorage
  def add_note(event)
    # ...
  end

  # Cache management
  def update_cache
    # ...
  end
end
```

### 4. Offline Detector Controller

Monitors online/offline status:

```ruby
class OfflineDetectorController < StimulusController
  def connect
    # Listen for online/offline events
    window.addEventListener('online', ...)
    window.addEventListener('offline', ...)
  end
end
```

## Testing PWA Features

### 1. Install the App

**On Desktop:**
- Chrome: Click the install icon in the address bar
- Edge: Click the app icon in the address bar
- Firefox: Click "Install" in the page actions menu

**On Mobile:**
- Safari (iOS): Tap Share → Add to Home Screen
- Chrome (Android): Tap menu → Install app

### 2. Test Offline Mode

**Using DevTools:**
1. Open DevTools (F12)
2. Go to Network tab
3. Set throttling to "Offline"
4. Try navigating and adding notes

**Using Service Worker:**
1. Open DevTools → Application tab → Service Workers
2. Check "Offline" checkbox
3. Reload the page - it should still work!

### 3. View Cached Resources

1. Open DevTools → Application tab
2. Click "Cache Storage" in the sidebar
3. Expand the cache to see all cached files

### 4. Test on Mobile

For the best PWA experience:
1. Deploy to a server with HTTPS
2. Open on mobile device
3. Install to home screen
4. Launch from home screen icon

## PWA Requirements

### Production Checklist

- [x] **HTTPS**: Required for service workers (except localhost)
- [x] **Web App Manifest**: Generated by vite-plugin-pwa
- [x] **Service Worker**: Generated by vite-plugin-pwa
- [x] **Icons**: Multiple sizes (192x192, 512x512)
- [x] **Standalone Display**: Configured in manifest
- [x] **Theme Color**: Set in manifest and meta tag
- [x] **Offline Functionality**: Service worker caching
- [x] **Responsive Design**: Works on all screen sizes

### Development vs Production

**Development (localhost):**
- Service worker may not be fully functional
- Install prompt may not appear
- Some PWA features require HTTPS

**Production (HTTPS):**
- Full service worker functionality
- Install prompt appears
- All PWA features work
- Lighthouse PWA audit passes

## Offline Notes Feature

The app includes an offline-capable note-taking feature:

```ruby
def add_note(event)
  `
    const note = {
      id: Date.now(),
      text: noteText,
      createdAt: new Date().toISOString(),
      synced: navigator.onLine  // Track online status
    };

    ctrl.notes.unshift(note);
    localStorage.setItem('pwa-notes', JSON.stringify(ctrl.notes));
  `
end
```

**Features:**
- Notes work offline using localStorage
- Sync indicator (cloud icon when online, phone icon when offline)
- Persist across sessions
- Delete functionality

## Cache Management

### Update Cache

Manually check for service worker updates:

```ruby
def update_cache
  `
    navigator.serviceWorker.getRegistration().then(function(registration) {
      registration.update(); // Force update check
    });
  `
end
```

### Clear Cache

Clear all caches:

```ruby
def clear_cache
  `
    caches.keys().then(function(names) {
      return Promise.all(
        names.map(function(name) {
          return caches.delete(name);
        })
      );
    });
  `
end
```

## Customizing the PWA

### Change Theme Color

Update in `vite.config.ts` and `index.html`:

```typescript
// vite.config.ts
manifest: {
  theme_color: '#your-color',
  background_color: '#your-color'
}
```

```html
<!-- index.html -->
<meta name="theme-color" content="#your-color" />
```

### Add Custom Caching

Add custom runtime caching in `vite.config.ts`:

```typescript
workbox: {
  runtimeCaching: [
    {
      urlPattern: /^https:\/\/api\.example\.com\/.*/i,
      handler: 'NetworkFirst',
      options: {
        cacheName: 'api-cache',
        expiration: {
          maxEntries: 50,
          maxAgeSeconds: 60 * 5 // 5 minutes
        }
      }
    }
  ]
}
```

### Customize Icons

Replace icons in `public/icons/` with your own:
- `icon-192.png` (192x192)
- `icon-512.png` (512x512)

Update manifest in `vite.config.ts` if needed.

## Caching Strategies

### Workbox Strategies

1. **CacheFirst**: Check cache, fall back to network
   - Best for: Static assets, fonts, images

2. **NetworkFirst**: Try network, fall back to cache
   - Best for: API calls, dynamic content

3. **StaleWhileRevalidate**: Return cache, update in background
   - Best for: Semi-static content

4. **NetworkOnly**: Always use network
   - Best for: Critical data that must be fresh

5. **CacheOnly**: Always use cache
   - Best for: Precached resources

## Browser Support

- **Chrome/Edge**: Full PWA support
- **Safari (iOS)**: Basic PWA support (no install prompt)
- **Firefox**: Full PWA support
- **Service Workers**: All modern browsers
- **No IE11 support**

## Performance Tips

1. **Minimize Cache**: Only cache what you need
2. **Use Appropriate Strategies**: Match strategy to content type
3. **Set Expiration**: Prevent cache bloat
4. **Precache Wisely**: Don't precache too much
5. **Test Offline**: Ensure offline experience is smooth

## Debugging

### Service Worker Issues

**Check Registration:**
```javascript
navigator.serviceWorker.getRegistration().then(console.log);
```

**View Console:**
```
DevTools → Application → Service Workers → View errors
```

**Force Update:**
```
DevTools → Application → Service Workers → Update button
```

### Cache Issues

**View Caches:**
```
DevTools → Application → Cache Storage
```

**Clear Specific Cache:**
```javascript
caches.delete('cache-name');
```

## Deployment

### Build and Deploy

```bash
# Build for production
pnpm build

# Preview production build locally
pnpm preview
```

The `dist/` folder contains:
- All static assets
- Service worker (`sw.js`)
- Web app manifest (`manifest.webmanifest`)

### Deploy to Vercel/Netlify

The build output is ready to deploy to any static hosting:

```bash
# Deploy to Vercel
vercel deploy dist

# Deploy to Netlify
netlify deploy --prod --dir=dist
```

## Related Examples

- [Form Validation](../form-validation-app) - Real-time form validation
- [i18n App](../i18n-app) - Multi-language support
- [Practical App](../practical-app) - Todo list with localStorage

## Resources

- [PWA Documentation](https://web.dev/progressive-web-apps/)
- [vite-plugin-pwa](https://vite-pwa-org.netlify.app/)
- [Workbox](https://developer.chrome.com/docs/workbox/)
- [Service Workers](https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API)

## License

MIT
