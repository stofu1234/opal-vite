import{_ as i,c as a,o as e,ag as n}from"./chunks/framework.CgSRFIgr.js";const d=JSON.parse('{"title":"Source Maps in opal-vite","description":"","frontmatter":{},"headers":[],"relativePath":"guide/source-maps.md","filePath":"guide/source-maps.md"}'),t={name:"guide/source-maps.md"};function l(p,s,o,r,h,k){return e(),a("div",null,[...s[0]||(s[0]=[n(`<h1 id="source-maps-in-opal-vite" tabindex="-1">Source Maps in opal-vite <a class="header-anchor" href="#source-maps-in-opal-vite" aria-label="Permalink to &quot;Source Maps in opal-vite&quot;">​</a></h1><p>Source maps allow you to debug your Ruby code directly in browser DevTools, even though it&#39;s compiled to JavaScript.</p><blockquote><p><strong>⚠️ Experimental Feature</strong>: Source maps are currently experimental. There are known compatibility issues with Vite&#39;s source map chain processing when compiling files with multiple <code>require</code> statements. Single-file compilation works, but complex applications may encounter errors.</p></blockquote><h2 id="overview" tabindex="-1">Overview <a class="header-anchor" href="#overview" aria-label="Permalink to &quot;Overview&quot;">​</a></h2><p>When source maps are enabled, opal-vite generates Source Map v3 compatible mappings that:</p><ol><li><strong>Map JavaScript back to Ruby</strong> - Click on errors in DevTools to see the original Ruby line</li><li><strong>Include original source</strong> - The Ruby source code is embedded in the source map</li><li><strong>Support browser debugging</strong> - Set breakpoints in your Ruby files</li></ol><h2 id="configuration" tabindex="-1">Configuration <a class="header-anchor" href="#configuration" aria-label="Permalink to &quot;Configuration&quot;">​</a></h2><h3 id="vite-plugin-options" tabindex="-1">Vite Plugin Options <a class="header-anchor" href="#vite-plugin-options" aria-label="Permalink to &quot;Vite Plugin Options&quot;">​</a></h3><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { defineConfig } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;vite&#39;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> opal </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;vite-plugin-opal&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> default</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> defineConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  plugins: [</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    opal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      sourceMap: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Enabled by default</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    })</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  build: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    sourcemap: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Also enable for production builds</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span></code></pre></div><h3 id="ruby-configuration" tabindex="-1">Ruby Configuration <a class="header-anchor" href="#ruby-configuration" aria-label="Permalink to &quot;Ruby Configuration&quot;">​</a></h3><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Configure via Opal::Vite</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Opal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Vite</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">configure</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |config|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  config.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">source_map_enabled</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # Enabled by default</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h2 id="how-it-works" tabindex="-1">How It Works <a class="header-anchor" href="#how-it-works" aria-label="Permalink to &quot;How It Works&quot;">​</a></h2><ol><li><strong>Compilation</strong>: When Opal compiles Ruby to JavaScript, it generates source map data</li><li><strong>Index Format</strong>: Multiple files are combined into an index source map with sections</li><li><strong>Vite Integration</strong>: The source map is passed to Vite which handles the browser delivery</li><li><strong>Browser Display</strong>: DevTools shows Ruby files in the Sources panel</li></ol><h2 id="debugging-in-browser" tabindex="-1">Debugging in Browser <a class="header-anchor" href="#debugging-in-browser" aria-label="Permalink to &quot;Debugging in Browser&quot;">​</a></h2><ol><li>Open DevTools (F12)</li><li>Go to the <strong>Sources</strong> tab</li><li>Find your Ruby files under the source tree</li><li>Set breakpoints by clicking line numbers</li><li>Variable values are shown (though with JavaScript names)</li></ol><h2 id="source-map-structure" tabindex="-1">Source Map Structure <a class="header-anchor" href="#source-map-structure" aria-label="Permalink to &quot;Source Map Structure&quot;">​</a></h2><p>The generated source maps follow the v3 specification:</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;version&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;sections&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;offset&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;line&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;column&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;map&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;version&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;sources&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;app/opal/controllers/my_controller.rb&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;sourcesContent&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;# Original Ruby code...&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;names&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;method_name&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;variable&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;mappings&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;AAAA...&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h2 id="disabling-source-maps" tabindex="-1">Disabling Source Maps <a class="header-anchor" href="#disabling-source-maps" aria-label="Permalink to &quot;Disabling Source Maps&quot;">​</a></h2><p>For production builds where you don&#39;t want source maps:</p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// vite.config.ts</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> default</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> defineConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  plugins: [</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    opal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      sourceMap: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    })</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  build: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    sourcemap: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span></code></pre></div><h2 id="known-limitations" tabindex="-1">Known Limitations <a class="header-anchor" href="#known-limitations" aria-label="Permalink to &quot;Known Limitations&quot;">​</a></h2><h3 id="vite-source-map-chain-compatibility" tabindex="-1">Vite Source Map Chain Compatibility <a class="header-anchor" href="#vite-source-map-chain-compatibility" aria-label="Permalink to &quot;Vite Source Map Chain Compatibility&quot;">​</a></h3><p>When a Ruby file uses multiple <code>require</code> statements, Opal generates an &quot;index source map&quot; with multiple sections (one per file). Vite&#39;s internal <code>_getCombinedSourcemap</code> function has compatibility issues with this format.</p><p><strong>Workaround</strong>: For complex applications, keep <code>sourceMap: false</code> until this is resolved. Single-file Ruby scripts should work fine with source maps enabled.</p><h3 id="multiple-file-debugging" tabindex="-1">Multiple File Debugging <a class="header-anchor" href="#multiple-file-debugging" aria-label="Permalink to &quot;Multiple File Debugging&quot;">​</a></h3><p>Currently, only the main entry point file appears in browser DevTools. Required files (controllers, services, etc.) may not be visible for debugging.</p><h2 id="troubleshooting" tabindex="-1">Troubleshooting <a class="header-anchor" href="#troubleshooting" aria-label="Permalink to &quot;Troubleshooting&quot;">​</a></h2><h3 id="source-maps-not-appearing-in-devtools" tabindex="-1">Source maps not appearing in DevTools <a class="header-anchor" href="#source-maps-not-appearing-in-devtools" aria-label="Permalink to &quot;Source maps not appearing in DevTools&quot;">​</a></h3><ol><li>Ensure <code>sourceMap: true</code> in plugin options</li><li>Check Vite&#39;s <code>build.sourcemap</code> setting</li><li>Verify DevTools has &quot;Enable JavaScript source maps&quot; checked</li></ol><h3 id="cannot-read-properties-of-undefined-error" tabindex="-1">&quot;Cannot read properties of undefined&quot; error <a class="header-anchor" href="#cannot-read-properties-of-undefined-error" aria-label="Permalink to &quot;&quot;Cannot read properties of undefined&quot; error&quot;">​</a></h3><p>This error occurs when Vite&#39;s source map chain processing fails. Disable source maps:</p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">opal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  sourceMap: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span></code></pre></div><h3 id="incorrect-line-mappings" tabindex="-1">Incorrect line mappings <a class="header-anchor" href="#incorrect-line-mappings" aria-label="Permalink to &quot;Incorrect line mappings&quot;">​</a></h3><p>Opal&#39;s source maps map at the expression level, not character-by-character. Some complex Ruby expressions may map to approximate JavaScript locations.</p><h3 id="large-source-map-files" tabindex="-1">Large source map files <a class="header-anchor" href="#large-source-map-files" aria-label="Permalink to &quot;Large source map files&quot;">​</a></h3><p>Source maps include original source content. For production, consider:</p><ul><li>Setting <code>build.sourcemap: &#39;hidden&#39;</code> to generate but not reference</li><li>Using source maps only in development</li></ul><h2 id="performance" tabindex="-1">Performance <a class="header-anchor" href="#performance" aria-label="Permalink to &quot;Performance&quot;">​</a></h2><p>Source map generation adds minimal overhead to compilation (~5-10%). The maps are only generated once per file and cached by Vite.</p><h2 id="related-documentation" tabindex="-1">Related Documentation <a class="header-anchor" href="#related-documentation" aria-label="Permalink to &quot;Related Documentation&quot;">​</a></h2><ul><li><a href="https://opalrb.com/docs/guides/v1.4.1/source_maps.html" target="_blank" rel="noreferrer">Opal Source Maps Guide</a></li><li><a href="https://vitejs.dev/config/build-options.html#build-sourcemap" target="_blank" rel="noreferrer">Vite Source Maps Configuration</a></li><li><a href="https://sourcemaps.info/spec.html" target="_blank" rel="noreferrer">Source Map v3 Specification</a></li></ul>`,42)])])}const u=i(t,[["render",l]]);export{d as __pageData,u as default};
