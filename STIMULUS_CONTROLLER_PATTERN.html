<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Stimulus Controller Pattern: Ruby-Native Approach | opal-vite</title>
    <meta name="description" content="Ruby in the Browser with Vite">
    <meta name="generator" content="VitePress v1.6.4">
    <link rel="preload stylesheet" href="/opal-vite/assets/style.D-w-yS46.css" as="style">
    <link rel="preload stylesheet" href="/opal-vite/vp-icons.css" as="style">
    
    <script type="module" src="/opal-vite/assets/app.ClF1k8Ea.js"></script>
    <link rel="preload" href="/opal-vite/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/opal-vite/assets/chunks/theme.DENBpAx0.js">
    <link rel="modulepreload" href="/opal-vite/assets/chunks/framework.CgSRFIgr.js">
    <link rel="modulepreload" href="/opal-vite/assets/STIMULUS_CONTROLLER_PATTERN.md.BlE0E6Fu.lean.js">
    <link rel="icon" type="image/png" sizes="16x16" href="/opal-vite/opal_vite_speed_16.png">
    <link rel="icon" type="image/png" sizes="48x48" href="/opal-vite/opal_vite_speed_48.png">
    <link rel="apple-touch-icon" sizes="128x128" href="/opal-vite/opal_vite_speed_128.png">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-739c4398><!--[--><!--]--><!--[--><span tabindex="-1" data-v-a76f697a></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-a76f697a>Skip to content</a><!--]--><!----><header class="VPNav" data-v-739c4398 data-v-98e21520><div class="VPNavBar" data-v-98e21520 data-v-55872786><div class="wrapper" data-v-55872786><div class="container" data-v-55872786><div class="title" data-v-55872786><div class="VPNavBarTitle" data-v-55872786 data-v-077babc1><a class="title" href="/opal-vite/" data-v-077babc1><!--[--><!--]--><!--[--><img class="VPImage logo" src="/opal-vite/opal_vite_speed_48.png" alt data-v-a3a66fa6><!--]--><span data-v-077babc1>opal-vite</span><!--[--><!--]--></a></div></div><div class="content" data-v-55872786><div class="content-body" data-v-55872786><!--[--><!--]--><div class="VPNavBarSearch search" data-v-55872786><!--[--><!----><div id="local-search"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><span class="vp-icon DocSearch-Search-Icon"></span><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-55872786 data-v-c612d659><span id="main-nav-aria-label" class="visually-hidden" data-v-c612d659> Main Navigation </span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/opal-vite/" tabindex="0" data-v-c612d659 data-v-dd195381><!--[--><span data-v-dd195381>Home</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/opal-vite/guide/getting-started.html" tabindex="0" data-v-c612d659 data-v-dd195381><!--[--><span data-v-dd195381>Guide</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/opal-vite/api/v1/" tabindex="0" data-v-c612d659 data-v-dd195381><!--[--><span data-v-dd195381>API</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/opal-vite/playground.html" tabindex="0" data-v-c612d659 data-v-dd195381><!--[--><span data-v-dd195381>Playground</span><!--]--></a><!--]--><!--]--></nav><div class="VPFlyout VPNavBarTranslations translations" data-v-55872786 data-v-1c1cb354 data-v-cf3f84eb><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="Change language" data-v-cf3f84eb><span class="text" data-v-cf3f84eb><span class="vpi-languages option-icon" data-v-cf3f84eb></span><!----><span class="vpi-chevron-down text-icon" data-v-cf3f84eb></span></span></button><div class="menu" data-v-cf3f84eb><div class="VPMenu" data-v-cf3f84eb data-v-62a85627><!----><!--[--><!--[--><div class="items" data-v-1c1cb354><p class="title" data-v-1c1cb354>English</p><!--[--><div class="VPMenuLink" data-v-1c1cb354 data-v-97a4273b><a class="VPLink link" href="/opal-vite/ja/STIMULUS_CONTROLLER_PATTERN.html" data-v-97a4273b><!--[--><span data-v-97a4273b>日本語</span><!--]--></a></div><!--]--></div><!--]--><!--]--></div></div></div><div class="VPNavBarAppearance appearance" data-v-55872786 data-v-43d4e547><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-43d4e547 data-v-d666f4b1 data-v-21a86bcc><span class="check" data-v-21a86bcc><span class="icon" data-v-21a86bcc><!--[--><span class="vpi-sun sun" data-v-d666f4b1></span><span class="vpi-moon moon" data-v-d666f4b1></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-55872786 data-v-8b4f6738 data-v-bf919966><!--[--><a class="VPSocialLink no-icon" href="https://github.com/stofu1234/opal-vite" aria-label="github" target="_blank" rel="noopener" data-v-bf919966 data-v-656158ec><span class="vpi-social-github"></span></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-55872786 data-v-64ac9718 data-v-cf3f84eb><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-cf3f84eb><span class="vpi-more-horizontal icon" data-v-cf3f84eb></span></button><div class="menu" data-v-cf3f84eb><div class="VPMenu" data-v-cf3f84eb data-v-62a85627><!----><!--[--><!--[--><div class="group translations" data-v-64ac9718><p class="trans-title" data-v-64ac9718>English</p><!--[--><div class="VPMenuLink" data-v-64ac9718 data-v-97a4273b><a class="VPLink link" href="/opal-vite/ja/STIMULUS_CONTROLLER_PATTERN.html" data-v-97a4273b><!--[--><span data-v-97a4273b>日本語</span><!--]--></a></div><!--]--></div><div class="group" data-v-64ac9718><div class="item appearance" data-v-64ac9718><p class="label" data-v-64ac9718>Appearance</p><div class="appearance-action" data-v-64ac9718><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-64ac9718 data-v-d666f4b1 data-v-21a86bcc><span class="check" data-v-21a86bcc><span class="icon" data-v-21a86bcc><!--[--><span class="vpi-sun sun" data-v-d666f4b1></span><span class="vpi-moon moon" data-v-d666f4b1></span><!--]--></span></span></button></div></div></div><div class="group" data-v-64ac9718><div class="item social-links" data-v-64ac9718><div class="VPSocialLinks social-links-list" data-v-64ac9718 data-v-bf919966><!--[--><a class="VPSocialLink no-icon" href="https://github.com/stofu1234/opal-vite" aria-label="github" target="_blank" rel="noopener" data-v-bf919966 data-v-656158ec><span class="vpi-social-github"></span></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-55872786 data-v-1c130961><span class="container" data-v-1c130961><span class="top" data-v-1c130961></span><span class="middle" data-v-1c130961></span><span class="bottom" data-v-1c130961></span></span></button></div></div></div></div><div class="divider" data-v-55872786><div class="divider-line" data-v-55872786></div></div></div><!----></header><div class="VPLocalNav empty fixed" data-v-739c4398 data-v-a069854f><div class="container" data-v-a069854f><!----><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-a069854f data-v-d8bbcd89><button data-v-d8bbcd89>Return to top</button><!----></div></div></div><!----><div class="VPContent" id="VPContent" data-v-739c4398 data-v-d0c55440><div class="VPDoc has-aside" data-v-d0c55440 data-v-d5fcafba><!--[--><!--]--><div class="container" data-v-d5fcafba><div class="aside" data-v-d5fcafba><div class="aside-curtain" data-v-d5fcafba></div><div class="aside-container" data-v-d5fcafba><div class="aside-content" data-v-d5fcafba><div class="VPDocAside" data-v-d5fcafba data-v-dd6e6109><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-dd6e6109 data-v-aaab7c09><div class="content" data-v-aaab7c09><div class="outline-marker" data-v-aaab7c09></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-aaab7c09>On this page</div><ul class="VPDocOutlineItem root" data-v-aaab7c09 data-v-3d233ce3><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-dd6e6109></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-d5fcafba><div class="content-container" data-v-d5fcafba><!--[--><!--]--><main class="main" data-v-d5fcafba><div style="position:relative;" class="vp-doc _opal-vite_STIMULUS_CONTROLLER_PATTERN" data-v-d5fcafba><div><h1 id="stimulus-controller-pattern-ruby-native-approach" tabindex="-1">Stimulus Controller Pattern: Ruby-Native Approach <a class="header-anchor" href="#stimulus-controller-pattern-ruby-native-approach" aria-label="Permalink to &quot;Stimulus Controller Pattern: Ruby-Native Approach&quot;">​</a></h1><h2 id="概要" tabindex="-1">概要 <a class="header-anchor" href="#概要" aria-label="Permalink to &quot;概要&quot;">​</a></h2><p>このドキュメントでは、Opal-ViteプロジェクトにおけるStimulusコントローラーのRuby的な書き方について説明します。<code>opal_stimulus</code> gemと <code>opal_proxy</code> (JS::Proxy) を活用することで、Ruby構文でStimulusコントローラーを記述できます。</p><h2 id="推奨アプローチ-ruby構文の活用" tabindex="-1">推奨アプローチ: Ruby構文の活用 <a class="header-anchor" href="#推奨アプローチ-ruby構文の活用" aria-label="Permalink to &quot;推奨アプローチ: Ruby構文の活用&quot;">​</a></h2><p><code>opal_proxy</code> gemが提供する <code>JS::Proxy</code> クラスにより、以下の機能が自動的に提供されます：</p><ol><li><strong>method_missing</strong> によるsnake_case → camelCase自動変換</li><li><strong>[]アクセス</strong> でJSオブジェクトのプロパティに直接アクセス</li><li><strong>wrap_result</strong> でネストしたオブジェクトも自動的にProxyでラップ</li><li><strong>Enumerable</strong> をincludeしているのでeach等が使える</li></ol><h3 id="ruby構文での実装例" tabindex="-1">Ruby構文での実装例 <a class="header-anchor" href="#ruby構文での実装例" aria-label="Permalink to &quot;Ruby構文での実装例&quot;">​</a></h3><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> FormController</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> StimulusController</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  include</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Toastable</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  include</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> DomHelpers</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">targets</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;input&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;error&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> validate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(event)</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    input</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = event.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">current_target</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">           # camelCase → snake_case 自動変換</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = input.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">strip</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">              # Rubyのメソッドチェーン</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    required</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = input.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">has_attribute</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;data-required&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    error_message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">validate_value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(value, required)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    show_field_error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(input, error_message)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> submit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(event)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    event.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">prevent_default</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                  # preventDefault() → prevent_default</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    inputs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">query_all</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;[data-form-target=&quot;input&quot;]&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    inputs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">each</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |input|                 </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Enumerable#each が使える</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> has_class?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(input, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;error&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        show_error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Please fix errors&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)    </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Toastable concern</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    show_success</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Form submitted!&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  private</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> validate_value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(value, required)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;This field is required&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> required </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> value.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">empty?</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    nil</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h2 id="concernsによる共通機能の抽出" tabindex="-1">Concernsによる共通機能の抽出 <a class="header-anchor" href="#concernsによる共通機能の抽出" aria-label="Permalink to &quot;Concernsによる共通機能の抽出&quot;">​</a></h2><h3 id="toastable-トースト通知" tabindex="-1">Toastable (トースト通知) <a class="header-anchor" href="#toastable-トースト通知" aria-label="Permalink to &quot;Toastable (トースト通知)&quot;">​</a></h3><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">module</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Toastable</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> dispatch_toast</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(message, type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;info&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    `</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      const event = new CustomEvent(&#39;show-toast&#39;, {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        detail: { message: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{message}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">, type: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{type}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> }</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      });</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      window.dispatchEvent(event);</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    `</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> show_success</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(message)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    dispatch_toast</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(message, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;success&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> show_error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(message)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    dispatch_toast</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(message, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;error&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h3 id="domhelpers-dom操作" tabindex="-1">DomHelpers (DOM操作) <a class="header-anchor" href="#domhelpers-dom操作" aria-label="Permalink to &quot;DomHelpers (DOM操作)&quot;">​</a></h3><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">module</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> DomHelpers</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(selector)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    element.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">query_selector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(selector)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> query_all</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(selector)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    element.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">query_selector_all</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(selector)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> add_class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(el, class_name)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    el.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">class_list</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(class_name)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> has_class?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(el, class_name)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    el.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">class_list</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">contains</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(class_name)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> set_timeout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(delay_ms, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">block)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    window.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">set_timeout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(block, delay_ms)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h2 id="過去の問題と解決策の履歴" tabindex="-1">過去の問題と解決策の履歴 <a class="header-anchor" href="#過去の問題と解決策の履歴" aria-label="Permalink to &quot;過去の問題と解決策の履歴&quot;">​</a></h2><p>以下は、過去にJavaScript関数への置き換えを行った理由の記録です。現在は上記のRuby的アプローチを推奨しますが、参考として残しています。</p><h2 id="問題の背景" tabindex="-1">問題の背景 <a class="header-anchor" href="#問題の背景" aria-label="Permalink to &quot;問題の背景&quot;">​</a></h2><h3 id="発生した問題" tabindex="-1">発生した問題 <a class="header-anchor" href="#発生した問題" aria-label="Permalink to &quot;発生した問題&quot;">​</a></h3><p>以下の3つのサンプルアプリケーションで、同様のエラーが発生しました：</p><ol><li><strong>form-validation-app</strong></li><li><strong>i18n-app</strong></li><li><strong>pwa-app</strong></li></ol><h4 id="主なエラーメッセージ" tabindex="-1">主なエラーメッセージ <a class="header-anchor" href="#主なエラーメッセージ" aria-label="Permalink to &quot;主なエラーメッセージ&quot;">​</a></h4><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// エラー例1: メソッドが見つからない</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">TypeError</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: ctrl.updateStats is not a </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// エラー例2: Stimulusアクションメソッドが未定義</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Action</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">click</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">i18n</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">switchLanguage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&quot; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">references</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> undefined</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> method</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">switchLanguage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// エラー例3: 変数の重複宣言</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">SyntaxError</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Identifier</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &#39;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">forms</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&#39; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">has</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> already</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> been</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> declared</span></span></code></pre></div><h3 id="問題の原因" tabindex="-1">問題の原因 <a class="header-anchor" href="#問題の原因" aria-label="Permalink to &quot;問題の原因&quot;">​</a></h3><h4 id="_1-イベントパラメータのラッピング問題" tabindex="-1">1. イベントパラメータのラッピング問題 <a class="header-anchor" href="#_1-イベントパラメータのラッピング問題" aria-label="Permalink to &quot;1. イベントパラメータのラッピング問題&quot;">​</a></h4><p>Opalコンパイラは、Rubyメソッドのパラメータを特殊な方法で処理します。JavaScriptの<code>event</code>オブジェクトがOpalによってラップされるため、直接アクセスできない場合がありました。</p><p><strong>問題のあるコード例:</strong></p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> validate_field</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(event)</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  `</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    const field = event.target;  // eventがラップされているため動作しない</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  `</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h4 id="_2-メソッド名の変換問題" tabindex="-1">2. メソッド名の変換問題 <a class="header-anchor" href="#_2-メソッド名の変換問題" aria-label="Permalink to &quot;2. メソッド名の変換問題&quot;">​</a></h4><p>Rubyのスネークケース（<code>snake_case</code>）とJavaScriptのキャメルケース（<code>camelCase</code>）の変換において、Stimulusのアクション定義と実際のメソッド名が一致しない問題が発生しました。</p><p><strong>問題のあるコード例:</strong></p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># HTML側</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">button data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">action</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;click-&gt;i18n#switchLanguage&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Ruby側</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> switch_language</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(event)  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># snake_case</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # ...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Stimulusは switchLanguage を探すが、</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Opalは switch_language として登録するため見つからない</span></span></code></pre></div><h4 id="_3-メソッド呼び出しの問題" tabindex="-1">3. メソッド呼び出しの問題 <a class="header-anchor" href="#_3-メソッド呼び出しの問題" aria-label="Permalink to &quot;3. メソッド呼び出しの問題&quot;">​</a></h4><p><code>connect()</code>メソッド内のJavaScriptコードから、別のRubyメソッドを呼び出す際、正しいプレフィックス（<code>$</code>）とメソッド名（スネークケース）を使用する必要がありました。</p><p><strong>問題のあるコード例:</strong></p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> connect</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  `</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    ctrl.updateTranslations();  // ✗ 動作しない</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    ctrl.$update_translations(); // ✓ 正しい呼び出し方</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  `</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> update_translations</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # ...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h4 id="_4-変数の重複宣言" tabindex="-1">4. 変数の重複宣言 <a class="header-anchor" href="#_4-変数の重複宣言" aria-label="Permalink to &quot;4. 変数の重複宣言&quot;">​</a></h4><p>Rubyメソッドのパラメータと、バッククォート内のJavaScript変数宣言が競合しました。</p><p><strong>問題のあるコード例:</strong></p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> pluralize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(forms, count)  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Rubyパラメータ</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  `</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    const forms = arguments[0];  // JavaScriptで再宣言 → エラー!</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    const count = arguments[1];</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  `</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h2 id="解決策-javascript関数への統一" tabindex="-1">解決策: JavaScript関数への統一 <a class="header-anchor" href="#解決策-javascript関数への統一" aria-label="Permalink to &quot;解決策: JavaScript関数への統一&quot;">​</a></h2><h3 id="アプローチ" tabindex="-1">アプローチ <a class="header-anchor" href="#アプローチ" aria-label="Permalink to &quot;アプローチ&quot;">​</a></h3><p>すべてのメソッドロジックを<code>connect()</code>メソッド内でJavaScript関数として定義することで、上記の問題をすべて解決しました。</p><h3 id="実装パターン" tabindex="-1">実装パターン <a class="header-anchor" href="#実装パターン" aria-label="Permalink to &quot;実装パターン&quot;">​</a></h3><h4 id="パターン1-ヘルパー関数" tabindex="-1">パターン1: ヘルパー関数 <a class="header-anchor" href="#パターン1-ヘルパー関数" aria-label="Permalink to &quot;パターン1: ヘルパー関数&quot;">​</a></h4><p>内部的に使用する関数は<code>ctrl.functionName</code>として定義します。</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> connect</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  `</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    const ctrl = this;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    // ヘルパー関数の定義</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    ctrl.updateStats = function() {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      const total = ctrl.fieldTargets.length;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      // ... 処理</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    ctrl.formatCurrency = function(amount) {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      return new Intl.NumberFormat(ctrl.currentLocaleValue, {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        style: &#39;currency&#39;,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        currency: &#39;USD&#39;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      }).format(amount);</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    };</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  `</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h4 id="パターン2-stimulusアクションメソッド" tabindex="-1">パターン2: Stimulusアクションメソッド <a class="header-anchor" href="#パターン2-stimulusアクションメソッド" aria-label="Permalink to &quot;パターン2: Stimulusアクションメソッド&quot;">​</a></h4><p>Stimulusから呼び出されるアクションメソッドは<code>this.methodName</code>として定義します。</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> connect</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  `</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    const ctrl = this;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    // Stimulusアクションメソッド（キャメルケース）</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    this.switchLanguage = function(event) {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      const locale = event.currentTarget.dataset.locale;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      ctrl.currentLocaleValue = locale;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      ctrl.updateTranslations();</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    this.handleSubmit = function(event) {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      event.preventDefault();</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      // フォーム送信処理</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    };</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  `</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h4 id="パターン3-初期化処理" tabindex="-1">パターン3: 初期化処理 <a class="header-anchor" href="#パターン3-初期化処理" aria-label="Permalink to &quot;パターン3: 初期化処理&quot;">​</a></h4><p><code>connect()</code>メソッドの最後で、初期化処理を実行します。</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> connect</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  `</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    const ctrl = this;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    // 関数定義...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    // 初期化</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    ctrl.loadData();</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    ctrl.updateDisplay();</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  `</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h2 id="修正前後の比較" tabindex="-1">修正前後の比較 <a class="header-anchor" href="#修正前後の比較" aria-label="Permalink to &quot;修正前後の比較&quot;">​</a></h2><h3 id="before-修正前" tabindex="-1">Before（修正前） <a class="header-anchor" href="#before-修正前" aria-label="Permalink to &quot;Before（修正前）&quot;">​</a></h3><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> I18nController</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> StimulusController</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> connect</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    `</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      const ctrl = this;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      ctrl.updateTranslations();  // ✗ エラー: メソッドが見つからない</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    `</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> switch_language</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(event)  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ✗ Stimulusが見つけられない</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    `</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      const locale = event.currentTarget.dataset.locale;  # ✗ eventラッピング問題</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      // ...</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    `</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> update_translations</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    `</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      const ctrl = this;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      // ...</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    `</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> pluralize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(forms, count)</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    `</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      const forms = arguments[0];  # ✗ 重複宣言エラー</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      const count = arguments[1];</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      // ...</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    `</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h3 id="after-修正後" tabindex="-1">After（修正後） <a class="header-anchor" href="#after-修正後" aria-label="Permalink to &quot;After（修正後）&quot;">​</a></h3><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> I18nController</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> StimulusController</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> connect</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    `</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      const ctrl = this;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      // ヘルパー関数</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      ctrl.pluralize = function(forms, count) {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        let key = &#39;other&#39;;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        if (count === 0) key = &#39;zero&#39;;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        else if (count === 1) key = &#39;one&#39;;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        return forms[key].replace(&#39;{count}&#39;, count);</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      ctrl.updateTranslations = function() {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        const t = ctrl.translations[ctrl.currentLocaleValue];</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        // ... UI更新処理</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      // Stimulusアクションメソッド</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      this.switchLanguage = function(event) {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        const locale = event.currentTarget.dataset.locale;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        ctrl.currentLocaleValue = locale;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        ctrl.updateTranslations();</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      // 初期化</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      ctrl.updateTranslations();</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    `</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h2 id="メリット" tabindex="-1">メリット <a class="header-anchor" href="#メリット" aria-label="Permalink to &quot;メリット&quot;">​</a></h2><h3 id="_1-ブラウザエラーの完全解消" tabindex="-1">1. ブラウザエラーの完全解消 <a class="header-anchor" href="#_1-ブラウザエラーの完全解消" aria-label="Permalink to &quot;1. ブラウザエラーの完全解消&quot;">​</a></h3><ul><li>すべてのメソッド呼び出しエラーが解消</li><li>Stimulusアクションが正しく動作</li><li>変数の重複宣言エラーがなくなる</li></ul><h3 id="_2-コードの明確性向上" tabindex="-1">2. コードの明確性向上 <a class="header-anchor" href="#_2-コードの明確性向上" aria-label="Permalink to &quot;2. コードの明確性向上&quot;">​</a></h3><ul><li>すべてのロジックが<code>connect()</code>メソッド内に集約</li><li>JavaScript関数として直接定義されるため、動作が明確</li><li>イベントパラメータの扱いが簡潔</li></ul><h3 id="_3-メンテナンス性の向上" tabindex="-1">3. メンテナンス性の向上 <a class="header-anchor" href="#_3-メンテナンス性の向上" aria-label="Permalink to &quot;3. メンテナンス性の向上&quot;">​</a></h3><ul><li>Ruby/JavaScript間の変換問題を回避</li><li>一貫したパターンで実装可能</li><li>デバッグが容易</li></ul><h3 id="_4-パフォーマンス" tabindex="-1">4. パフォーマンス <a class="header-anchor" href="#_4-パフォーマンス" aria-label="Permalink to &quot;4. パフォーマンス&quot;">​</a></h3><ul><li>Opalのメソッド呼び出しオーバーヘッドがない</li><li>直接的なJavaScript実行</li></ul><h2 id="適用したアプリケーション" tabindex="-1">適用したアプリケーション <a class="header-anchor" href="#適用したアプリケーション" aria-label="Permalink to &quot;適用したアプリケーション&quot;">​</a></h2><p>このパターンは以下の3つのサンプルアプリケーションで適用され、すべてのブラウザエラーが解消されました：</p><h3 id="_1-form-validation-app" tabindex="-1">1. form-validation-app <a class="header-anchor" href="#_1-form-validation-app" aria-label="Permalink to &quot;1. form-validation-app&quot;">​</a></h3><p><strong>修正したメソッド:</strong></p><ul><li><code>validate_field</code> → <code>this.validate_field</code></li><li><code>clear_error</code> → <code>this.clear_error</code></li><li><code>handle_submit</code> → <code>this.handle_submit</code></li><li><code>reset_form</code> → <code>this.reset_form</code></li><li><code>update_stats</code> → <code>ctrl.updateStats</code></li><li><code>show_field_error</code> → <code>ctrl.showFieldError</code></li><li>その他ヘルパー関数</li></ul><p><strong>結果:</strong></p><ul><li>リアルタイムバリデーション動作 ✓</li><li>フォーム送信機能動作 ✓</li><li>統計表示更新動作 ✓</li></ul><h3 id="_2-i18n-app" tabindex="-1">2. i18n-app <a class="header-anchor" href="#_2-i18n-app" aria-label="Permalink to &quot;2. i18n-app&quot;">​</a></h3><p><strong>修正したメソッド:</strong></p><ul><li><code>switch_language</code> → <code>this.switchLanguage</code></li><li><code>handle_submit</code> → <code>this.handleSubmit</code></li><li><code>update_translations</code> → <code>ctrl.updateTranslations</code></li><li><code>pluralize</code> → <code>ctrl.pluralize</code></li><li><code>format_currency</code> → <code>ctrl.formatCurrency</code></li><li><code>format_date</code> → <code>ctrl.formatDate</code></li><li><code>format_time</code> → <code>ctrl.formatTime</code></li></ul><p><strong>結果:</strong></p><ul><li>5言語切り替え動作 ✓（EN, JA, ES, FR, DE）</li><li>動的翻訳更新 ✓</li><li>ロケール別フォーマット ✓</li></ul><h3 id="_3-pwa-app" tabindex="-1">3. pwa-app <a class="header-anchor" href="#_3-pwa-app" aria-label="Permalink to &quot;3. pwa-app&quot;">​</a></h3><p><strong>修正したコントローラー:</strong></p><h4 id="pwacontroller" tabindex="-1">PwaController <a class="header-anchor" href="#pwacontroller" aria-label="Permalink to &quot;PwaController&quot;">​</a></h4><ul><li><code>install</code> → <code>this.install</code></li><li><code>dismiss_install_prompt</code> → <code>this.dismissInstallPrompt</code></li><li><code>add_note</code> → <code>this.addNote</code></li><li><code>delete_note</code> → <code>this.deleteNote</code></li><li><code>update_cache</code> → <code>this.updateCache</code></li><li><code>clear_cache</code> → <code>this.clearCache</code></li><li>その他12のヘルパー関数</li></ul><h4 id="offlinedetectorcontroller" tabindex="-1">OfflineDetectorController <a class="header-anchor" href="#offlinedetectorcontroller" aria-label="Permalink to &quot;OfflineDetectorController&quot;">​</a></h4><ul><li><code>update_status</code> → <code>ctrl.updateStatus</code></li></ul><p><strong>結果:</strong></p><ul><li>PWAインストール機能動作 ✓</li><li>オフラインノート機能動作 ✓</li><li>キャッシュ管理動作 ✓</li><li>オンライン/オフライン検出動作 ✓</li></ul><h2 id="ベストプラクティス" tabindex="-1">ベストプラクティス <a class="header-anchor" href="#ベストプラクティス" aria-label="Permalink to &quot;ベストプラクティス&quot;">​</a></h2><h3 id="_1-一貫したパターンの使用" tabindex="-1">1. 一貫したパターンの使用 <a class="header-anchor" href="#_1-一貫したパターンの使用" aria-label="Permalink to &quot;1. 一貫したパターンの使用&quot;">​</a></h3><p>すべてのStimulusコントローラーで同じパターンを使用します：</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> MyController</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> StimulusController</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> connect</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    `</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      const ctrl = this;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      // 1. ヘルパー関数定義</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      ctrl.helperFunction = function() { /* ... */ };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      // 2. Stimulusアクションメソッド定義</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      this.actionMethod = function(event) { /* ... */ };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      // 3. 初期化処理</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      ctrl.initialize();</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    `</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h3 id="_2-命名規則" tabindex="-1">2. 命名規則 <a class="header-anchor" href="#_2-命名規則" aria-label="Permalink to &quot;2. 命名規則&quot;">​</a></h3><ul><li><p><strong>ヘルパー関数</strong>: キャメルケース、<code>ctrl.</code>プレフィックス</p><ul><li>例: <code>ctrl.updateDisplay()</code>, <code>ctrl.formatData()</code></li></ul></li><li><p><strong>Stimulusアクション</strong>: キャメルケース、<code>this.</code>プレフィックス</p><ul><li>例: <code>this.handleClick()</code>, <code>this.submitForm()</code></li></ul></li></ul><h3 id="_3-イベント処理" tabindex="-1">3. イベント処理 <a class="header-anchor" href="#_3-イベント処理" aria-label="Permalink to &quot;3. イベント処理&quot;">​</a></h3><p>イベントパラメータを直接使用できます：</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">this.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">handleClick</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(event) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  event.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">preventDefault</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  const target </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> event.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">currentTarget</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  const value </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> target.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">dataset</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">  //</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></div><h3 id="_4-stimulus-targets-values-の使用" tabindex="-1">4. Stimulus Targets/Values の使用 <a class="header-anchor" href="#_4-stimulus-targets-values-の使用" aria-label="Permalink to &quot;4. Stimulus Targets/Values の使用&quot;">​</a></h3><p>Stimulusの機能は通常通り使用できます：</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  const ctrl = this;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  if (ctrl.hasMyTarget) {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    ctrl.myTarget.textContent = &#39;Updated&#39;;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  ctrl.myValueValue = &#39;new value&#39;;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`</span></span></code></pre></div><h2 id="トラブルシューティング" tabindex="-1">トラブルシューティング <a class="header-anchor" href="#トラブルシューティング" aria-label="Permalink to &quot;トラブルシューティング&quot;">​</a></h2><h3 id="よくある問題と解決策" tabindex="-1">よくある問題と解決策 <a class="header-anchor" href="#よくある問題と解決策" aria-label="Permalink to &quot;よくある問題と解決策&quot;">​</a></h3><h4 id="問題1-method-is-not-a-function" tabindex="-1">問題1: &quot;Method is not a function&quot; <a class="header-anchor" href="#問題1-method-is-not-a-function" aria-label="Permalink to &quot;問題1: &quot;Method is not a function&quot;&quot;">​</a></h4><p><strong>原因</strong>: メソッドが関数として定義されていない</p><p><strong>解決策</strong>:</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ✗ 間違い</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> connect</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  `ctrl.myMethod();`</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> my_method</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  `console.log(&#39;test&#39;);`</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ✓ 正しい</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> connect</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  `</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    const ctrl = this;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    ctrl.myMethod = function() {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      console.log(&#39;test&#39;);</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    };</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    ctrl.myMethod();</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  `</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h4 id="問題2-undefined-method-for-stimulus-action" tabindex="-1">問題2: &quot;Undefined method&quot; for Stimulus action <a class="header-anchor" href="#問題2-undefined-method-for-stimulus-action" aria-label="Permalink to &quot;問題2: &quot;Undefined method&quot; for Stimulus action&quot;">​</a></h4><p><strong>原因</strong>: アクションメソッドが<code>this.</code>で定義されていない</p><p><strong>解決策</strong>:</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># HTML: data-action=&quot;click-&gt;my#doSomething&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ✓ 正しい</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">this.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">doSomething</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(event) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  //</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> キャメルケースで定義</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></div><h4 id="問題3-targetsにアクセスできない" tabindex="-1">問題3: Targetsにアクセスできない <a class="header-anchor" href="#問題3-targetsにアクセスできない" aria-label="Permalink to &quot;問題3: Targetsにアクセスできない&quot;">​</a></h4><p><strong>原因</strong>: <code>ctrl</code>参照を使用していない</p><p><strong>解決策</strong>:</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  const ctrl = this;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  // ✓ 正しい</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  ctrl.myTarget.textContent = &#39;text&#39;;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  // 関数内でも ctrl を使用</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  ctrl.updateDisplay = function() {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    ctrl.myTarget.textContent = &#39;updated&#39;;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  };</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`</span></span></code></pre></div><h2 id="結論" tabindex="-1">結論 <a class="header-anchor" href="#結論" aria-label="Permalink to &quot;結論&quot;">​</a></h2><h3 id="推奨-ruby構文を活用したパターン" tabindex="-1">推奨: Ruby構文を活用したパターン <a class="header-anchor" href="#推奨-ruby構文を活用したパターン" aria-label="Permalink to &quot;推奨: Ruby構文を活用したパターン&quot;">​</a></h3><p>opal-viteの存在意義を最大限に活かすため、<strong>Ruby構文を積極的に使用する</strong>ことを推奨します：</p><ol><li><strong>Ruby的な記述</strong>: <code>opal_proxy</code> の <code>JS::Proxy</code> によりsnake_case → camelCase変換が自動で行われる</li><li><strong>Concernsの活用</strong>: 共通機能を<code>Toastable</code>や<code>DomHelpers</code>などのモジュールに抽出</li><li><strong>イベント引数</strong>: Stimulusアクションの引数は自動的に<code>JS::Proxy</code>でラップされる</li><li><strong>プロパティアクセス</strong>: <code>event.current_target</code>、<code>input.class_list</code>などRuby風にアクセス</li></ol><h3 id="バッククォートが必要なケース" tabindex="-1">バッククォートが必要なケース <a class="header-anchor" href="#バッククォートが必要なケース" aria-label="Permalink to &quot;バッククォートが必要なケース&quot;">​</a></h3><p>以下の場合のみバッククォート内にJavaScriptを記述します：</p><ol><li><strong>イベントリスナーのコールバック</strong>: <code>window.add_event_listener</code>のブロック内でeventオブジェクトが適切にラップされないため</li><li><strong>CustomEventの作成</strong>: <code>new CustomEvent(...)</code></li><li><strong>正規表現のテスト</strong>: JavaScriptのRegExpを使う場合</li></ol><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># バッククォートが必要な例</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> connect</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  `</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    window.addEventListener(&#39;show-toast&#39;, (e) =&gt; {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      this.$show(e.detail.message, e.detail.type || &#39;info&#39;);</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    });</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  `</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Ruby構文で書ける例</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> validate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(event)</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  input</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = event.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">current_target</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # Ruby風にアクセス</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  input.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">class_list</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;error&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># method_missingで変換</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><p>このハイブリッドアプローチにより、Rubyの表現力を最大限活かしながら、JavaScriptとの相互運用も可能です。</p><h2 id="参考リンク" tabindex="-1">参考リンク <a class="header-anchor" href="#参考リンク" aria-label="Permalink to &quot;参考リンク&quot;">​</a></h2><ul><li><a href="https://stimulus.hotwired.dev/handbook/introduction" target="_blank" rel="noreferrer">Stimulus Handbook</a></li><li><a href="https://opalrb.com/" target="_blank" rel="noreferrer">Opal Documentation</a></li><li><a href="https://github.com/your-repo/opal_stimulus" target="_blank" rel="noreferrer">opal_stimulus gem</a></li></ul><hr><p><strong>ドキュメント作成日</strong>: 2025-12-15 <strong>対象バージョン</strong>: Opal-Vite v1.0.0</p></div></div></main><footer class="VPDocFooter" data-v-d5fcafba data-v-926023ce><!--[--><!--]--><!----><!----></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><footer class="VPFooter" data-v-739c4398 data-v-30587f53><div class="container" data-v-30587f53><p class="message" data-v-30587f53>Released under the MIT License.</p><p class="copyright" data-v-30587f53>Copyright © 2024-present stofu1234</p></div></footer><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"api_v1_en_dom_helpers.md\":\"BbUzhIF2\",\"api_v1_en_js_proxy_ex.md\":\"D7wMgnwt\",\"api_v1_en_react_helpers.md\":\"CB0YwlQM\",\"api_v1_en_readme.md\":\"ByhXbiHb\",\"api_v1_en_stimulus_helpers.md\":\"DPwv1qap\",\"api_v1_en_storable.md\":\"DSzg7KBo\",\"api_v1_en_toastable.md\":\"D4gbzpeM\",\"api_v1_en_vue_helpers.md\":\"Di60SeDU\",\"api_v1_index.md\":\"BmwUyTna\",\"api_v1_ja_dom_helpers.md\":\"BNxA8C4U\",\"api_v1_ja_js_proxy_ex.md\":\"CeBoFl-G\",\"api_v1_ja_react_helpers.md\":\"pwdoA7pH\",\"api_v1_ja_readme.md\":\"D5fYkIzU\",\"api_v1_ja_stimulus_helpers.md\":\"BSXiSm94\",\"api_v1_ja_storable.md\":\"DbI0uA08\",\"api_v1_ja_toastable.md\":\"D7hSAklC\",\"api_v1_ja_vue_helpers.md\":\"D5hgSV4Z\",\"api_v1_readme.md\":\"CMYobiMh\",\"guide_getting-started.md\":\"C_g40tMa\",\"guide_installation.md\":\"ZLUzhto8\",\"guide_migration.md\":\"DucAuCyP\",\"guide_source-maps.md\":\"B00oItzH\",\"guide_testing.md\":\"CGma2y-X\",\"guide_troubleshooting.md\":\"Bp4kAd1Z\",\"index.md\":\"D9g3oJJE\",\"ja_api_v1_index.md\":\"CyU3_nGg\",\"ja_guide_getting-started.md\":\"BWL7gaeG\",\"ja_guide_installation.md\":\"BKqhwJO0\",\"ja_index.md\":\"Btqe89uv\",\"ja_playground.md\":\"CPhjsC6w\",\"migration.md\":\"Dsv5vaPs\",\"opal_stimulus_feedback.md\":\"DO52N0oX\",\"playground.md\":\"EfIjdALf\",\"source_maps.md\":\"D1Fk20sz\",\"stimulus_controller_pattern.md\":\"BlE0E6Fu\",\"testing.md\":\"Cz_4xWnF\",\"troubleshooting.md\":\"Cy4nXtsm\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"opal-vite\",\"description\":\"Ruby in the Browser with Vite\",\"base\":\"/opal-vite/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"logo\":\"/opal_vite_speed_48.png\",\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/stofu1234/opal-vite\"}],\"footer\":{\"message\":\"Released under the MIT License.\",\"copyright\":\"Copyright © 2024-present stofu1234\"},\"search\":{\"provider\":\"local\"}},\"locales\":{\"root\":{\"label\":\"English\",\"lang\":\"en\",\"themeConfig\":{\"nav\":[{\"text\":\"Home\",\"link\":\"/\"},{\"text\":\"Guide\",\"link\":\"/guide/getting-started\"},{\"text\":\"API\",\"link\":\"/api/v1/\"},{\"text\":\"Playground\",\"link\":\"/playground\"}],\"sidebar\":{\"/guide/\":[{\"text\":\"Introduction\",\"items\":[{\"text\":\"Getting Started\",\"link\":\"/guide/getting-started\"},{\"text\":\"Installation\",\"link\":\"/guide/installation\"}]},{\"text\":\"Advanced\",\"items\":[{\"text\":\"Migration\",\"link\":\"/guide/migration\"},{\"text\":\"Source Maps\",\"link\":\"/guide/source-maps\"},{\"text\":\"Testing\",\"link\":\"/guide/testing\"},{\"text\":\"Troubleshooting\",\"link\":\"/guide/troubleshooting\"}]}],\"/api/v1/\":[{\"text\":\"API Reference\",\"items\":[{\"text\":\"Overview\",\"link\":\"/api/v1/\"},{\"text\":\"StimulusHelpers\",\"link\":\"/api/v1/en/stimulus_helpers\"},{\"text\":\"DomHelpers\",\"link\":\"/api/v1/en/dom_helpers\"},{\"text\":\"Storable\",\"link\":\"/api/v1/en/storable\"},{\"text\":\"Toastable\",\"link\":\"/api/v1/en/toastable\"},{\"text\":\"JsProxyEx\",\"link\":\"/api/v1/en/js_proxy_ex\"},{\"text\":\"VueHelpers\",\"link\":\"/api/v1/en/vue_helpers\"},{\"text\":\"ReactHelpers\",\"link\":\"/api/v1/en/react_helpers\"}]}]}}},\"ja\":{\"label\":\"日本語\",\"lang\":\"ja\",\"link\":\"/ja/\",\"themeConfig\":{\"nav\":[{\"text\":\"ホーム\",\"link\":\"/ja/\"},{\"text\":\"ガイド\",\"link\":\"/ja/guide/getting-started\"},{\"text\":\"API\",\"link\":\"/ja/api/v1/\"},{\"text\":\"Playground\",\"link\":\"/ja/playground\"}],\"sidebar\":{\"/ja/guide/\":[{\"text\":\"はじめに\",\"items\":[{\"text\":\"クイックスタート\",\"link\":\"/ja/guide/getting-started\"},{\"text\":\"インストール\",\"link\":\"/ja/guide/installation\"}]},{\"text\":\"詳細\",\"items\":[{\"text\":\"マイグレーション\",\"link\":\"/ja/guide/migration\"},{\"text\":\"ソースマップ\",\"link\":\"/ja/guide/source-maps\"},{\"text\":\"テスト\",\"link\":\"/ja/guide/testing\"},{\"text\":\"トラブルシューティング\",\"link\":\"/ja/guide/troubleshooting\"}]}],\"/ja/api/v1/\":[{\"text\":\"APIリファレンス\",\"items\":[{\"text\":\"概要\",\"link\":\"/ja/api/v1/\"},{\"text\":\"StimulusHelpers\",\"link\":\"/api/v1/ja/stimulus_helpers\"},{\"text\":\"DomHelpers\",\"link\":\"/api/v1/ja/dom_helpers\"},{\"text\":\"Storable\",\"link\":\"/api/v1/ja/storable\"},{\"text\":\"Toastable\",\"link\":\"/api/v1/ja/toastable\"},{\"text\":\"JsProxyEx\",\"link\":\"/api/v1/ja/js_proxy_ex\"},{\"text\":\"VueHelpers\",\"link\":\"/api/v1/ja/vue_helpers\"},{\"text\":\"ReactHelpers\",\"link\":\"/api/v1/ja/react_helpers\"}]}]}}}},\"scrollOffset\":134,\"cleanUrls\":false}");</script>
    
  </body>
</html>